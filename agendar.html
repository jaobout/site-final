<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agendar Serviço</title>
<style>
body{background:#0b0b0b;color:#fff;font-family:Arial;padding:20px}
.box{padding:20px;background:#111;border-radius:12px;max-width:480px;margin:auto}
label,select,button{display:block;width:100%;margin-top:12px}
button{padding:12px;border-radius:10px;border:0;background:#25D366;color:#fff;font-weight:bold;font-size:1rem}
.option{padding:10px;border:1px solid #444;border-radius:8px;margin:6px 0;cursor:pointer}
.option:hover{background:#222}
</style>
</head>
<body>

<div class="box">
<h2 id="servico"></h2>

<label>Escolha a data:</label>
<input type="date" id="data" />

<div id="horarios"></div>
</div>

<script>
// serviço
const url = new URL(window.location);
const servico = url.searchParams.get("servico") || "Serviço";
document.getElementById("servico").innerText = "Agendar: " + servico;

// expediente
function gerarHorarios(dataSel){
    const h = [];
    let inicio = new Date(dataSel);
    inicio.setHours(9,30,0,0);
    let fim = new Date(dataSel);
    fim.setHours(20,0,0,0);

    if(inicio.getDay()===5) fim.setHours(21,0,0,0);     // sexta
    if(inicio.getDay()===6) fim.setHours(20,0,0,0);     // sábado
    if(inicio.getDay()===0) fim.setHours(26,0,0,0);     // domingo 02:00 (26h)

    while(inicio <= fim){
        h.push(inicio.toTimeString().slice(0,5));
        inicio = new Date(inicio.getTime() + 60*60*1000);
    }
    return h;
}

// parse ICS local
async function getOcupados(){
    const txt = await fetch('agenda.ics').then(r=>r.text());
    const eventos = [];
    const linhas = txt.split(/\r?\n/);
    let dtstart=null, dtend=null;

    for(let l of linhas){
        if(l.startsWith("DTSTART")){
            dtstart = l.split(":")[1];
        }
        if(l.startsWith("DTEND")){
            dtend = l.split(":")[1];
        }
        if(l==="END:VEVENT"){
            if(dtstart && dtend) eventos.push({ini:dtstart,end:dtend});
            dtstart=null; dtend=null;
        }
    }
    return eventos;
}

// verifica se horário está dentro de evento
function ocupado(horario, dataSel, eventos){
    const [h,m] = horario.split(":").map(Number);
    const t = new Date(dataSel);
    t.setHours(h,m,0,0);

    return eventos.some(ev=>{
        const ini = new Date(ev.ini.substring(0,4), ev.ini.substring(4,6)-1, ev.ini.substring(6,8),
                             ev.ini.substring(9,11), ev.ini.substring(11,13));
        const end = new Date(ev.end.substring(0,4), ev.end.substring(4,6)-1, ev.end.substring(6,8),
                             ev.end.substring(9,11), ev.end.substring(11,13));
        return t>=ini && t<end;
    });
}

// render horários
document.getElementById("data").addEventListener("change", async e=>{
    const dataSel = e.target.value;
    const box = document.getElementById("horarios");
    box.innerHTML = "Carregando..."
    const eventos = await getOcupados();
    const hs = gerarHorarios(new Date(dataSel));

    box.innerHTML = "";
    hs.forEach(h=>{
        if(!ocupado(h, dataSel, eventos)){
            const div = document.createElement("div");
            div.className = "option";
            div.innerText = h;
            div.onclick = ()=>{
                const msg = encodeURIComponent(`Olá! Quero agendar ${servico} no dia ${dataSel} às ${h}.`);
                window.open("https://wa.me/5521978893270?text="+msg);
            };
            box.appendChild(div);
        }
    });
});
</script>

</body>
</html>
